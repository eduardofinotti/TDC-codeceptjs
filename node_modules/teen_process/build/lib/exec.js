"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.exec = exec;
exports.default = void 0;

require("source-map-support/register");

var _child_process = require("child_process");

var _shellQuote = require("shell-quote");

var _bluebird = _interopRequireDefault(require("bluebird"));

function exec(cmd, args = [], opts = {}) {
  const rep = (0, _shellQuote.quote)([cmd, ...args]);
  opts = Object.assign({
    timeout: null,
    encoding: 'utf8',
    killSignal: 'SIGTERM',
    cwd: undefined,
    env: process.env,
    ignoreOutput: false,
    stdio: "inherit",
    isBuffer: false,
    shell: undefined
  }, opts);
  return new _bluebird.default((resolve, reject) => {
    let proc = (0, _child_process.spawn)(cmd, args, {
      cwd: opts.cwd,
      env: opts.env,
      shell: opts.shell
    });
    let stdoutArr = [],
        stderrArr = [],
        timer = null;
    proc.on('error', err => {
      let msg = `Command '${rep}' errored out: ${err.stack}`;

      if (err.errno === 'ENOENT') {
        msg = `Command '${cmd}' not found. Is it installed?`;
      }

      reject(new Error(msg));
    });

    if (proc.stdin) {
      proc.stdin.on('error', err => {
        reject(new Error(`Standard input '${err.syscall}' error: ${err.stack}`));
      });
    }

    if (proc.stdout) {
      proc.stdout.on('error', err => {
        reject(new Error(`Standard output '${err.syscall}' error: ${err.stack}`));
      });
    }

    if (proc.stderr) {
      proc.stderr.on('error', err => {
        reject(new Error(`Standard error '${err.syscall}' error: ${err.stack}`));
      });
    }

    if (!opts.ignoreOutput) {
      if (proc.stdout) {
        proc.stdout.on('data', data => {
          stdoutArr.push(data);
        });
      }

      if (proc.stderr) {
        proc.stderr.on('data', data => {
          stderrArr.push(data);
        });
      }
    }

    function getStdio(isBuffer) {
      let stdout, stderr;

      if (isBuffer) {
        stdout = Buffer.concat(stdoutArr);
        stderr = Buffer.concat(stderrArr);
      } else {
        stdout = Buffer.concat(stdoutArr).toString(opts.encoding);
        stderr = Buffer.concat(stderrArr).toString(opts.encoding);
      }

      return {
        stdout,
        stderr
      };
    }

    proc.on('close', code => {
      if (timer) {
        clearTimeout(timer);
      }

      let {
        stdout,
        stderr
      } = getStdio(opts.isBuffer);

      if (code === 0) {
        resolve({
          stdout,
          stderr,
          code
        });
      } else {
        let err = new Error(`Command '${rep}' exited with code ${code}`);
        err = Object.assign(err, {
          stdout,
          stderr,
          code
        });
        reject(err);
      }
    });

    if (opts.timeout) {
      timer = setTimeout(() => {
        let {
          stdout,
          stderr
        } = getStdio(opts.isBuffer);
        let err = new Error(`Command '${rep}' timed out after ${opts.timeout}ms`);
        err = Object.assign(err, {
          stdout,
          stderr,
          code: null
        });
        reject(err);
        proc.kill(opts.killSignal);
      }, opts.timeout);
    }
  });
}

var _default = exec;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9leGVjLmpzIl0sIm5hbWVzIjpbImV4ZWMiLCJjbWQiLCJhcmdzIiwib3B0cyIsInJlcCIsIk9iamVjdCIsImFzc2lnbiIsInRpbWVvdXQiLCJlbmNvZGluZyIsImtpbGxTaWduYWwiLCJjd2QiLCJ1bmRlZmluZWQiLCJlbnYiLCJwcm9jZXNzIiwiaWdub3JlT3V0cHV0Iiwic3RkaW8iLCJpc0J1ZmZlciIsInNoZWxsIiwiQiIsInJlc29sdmUiLCJyZWplY3QiLCJwcm9jIiwic3Rkb3V0QXJyIiwic3RkZXJyQXJyIiwidGltZXIiLCJvbiIsImVyciIsIm1zZyIsInN0YWNrIiwiZXJybm8iLCJFcnJvciIsInN0ZGluIiwic3lzY2FsbCIsInN0ZG91dCIsInN0ZGVyciIsImRhdGEiLCJwdXNoIiwiZ2V0U3RkaW8iLCJCdWZmZXIiLCJjb25jYXQiLCJ0b1N0cmluZyIsImNvZGUiLCJjbGVhclRpbWVvdXQiLCJzZXRUaW1lb3V0Iiwia2lsbCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBR0EsU0FBU0EsSUFBVCxDQUFlQyxHQUFmLEVBQW9CQyxJQUFJLEdBQUcsRUFBM0IsRUFBK0JDLElBQUksR0FBRyxFQUF0QyxFQUEwQztBQUV4QyxRQUFNQyxHQUFHLEdBQUcsdUJBQU0sQ0FBQ0gsR0FBRCxFQUFNLEdBQUdDLElBQVQsQ0FBTixDQUFaO0FBSUFDLEVBQUFBLElBQUksR0FBR0UsTUFBTSxDQUFDQyxNQUFQLENBQWM7QUFDbkJDLElBQUFBLE9BQU8sRUFBRSxJQURVO0FBRW5CQyxJQUFBQSxRQUFRLEVBQUUsTUFGUztBQUduQkMsSUFBQUEsVUFBVSxFQUFFLFNBSE87QUFJbkJDLElBQUFBLEdBQUcsRUFBRUMsU0FKYztBQUtuQkMsSUFBQUEsR0FBRyxFQUFFQyxPQUFPLENBQUNELEdBTE07QUFNbkJFLElBQUFBLFlBQVksRUFBRSxLQU5LO0FBT25CQyxJQUFBQSxLQUFLLEVBQUUsU0FQWTtBQVFuQkMsSUFBQUEsUUFB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Q0FBTjtBQUNEO0FBQ0YsS0FaRDs7QUFpQkEsUUFBSXZCLElBQUksQ0FBQ0ksT0FBVCxFQUFrQjtBQUNoQmlCLE1BQUFBLEtBQUssR0FBR21CLFVBQVUsQ0FBQyxNQUFNO0FBQ3ZCLFlBQUk7QUFBQ1YsVUFBQUEsTUFBRDtBQUFTQyxVQUFBQTtBQUFULFlBQW1CRyxRQUFRLENBQUNsQyxJQUFJLENBQUNhLFFBQU4sQ0FBL0I7QUFDQSxZQUFJVSxHQUFHLEdBQUcsSUFBSUksS0FBSixDQUFXLFlBQVcxQixHQUFJLHFCQUFvQkQsSUFBSSxDQUFDSSxPQUFRLElBQTNELENBQVY7QUFDQW1CLFFBQUFBLEdBQUcsR0FBR3JCLE1BQU0sQ0FBQ0MsTUFBUCxDQUFjb0IsR0FBZCxFQUFtQjtBQUFDTyxVQUFBQSxNQUFEO0FBQVNDLFVBQUFBLE1BQVQ7QUFBaUJPLFVBQUFBLElBQUksRUFBRTtBQUF2QixTQUFuQixDQUFOO0FBQ0FyQixRQUFBQSxNQUFNLENBQUNNLEdBQUQsQ0FBTjtBQUdBTCxRQUFBQSxJQUFJLENBQUN1QixJQUFMLENBQVV6QyxJQUFJLENBQUNNLFVBQWY7QUFDRCxPQVJpQixFQVFmTixJQUFJLENBQUNJLE9BUlUsQ0FBbEI7QUFTRDtBQUNGLEdBdkZNLENBQVA7QUF3RkQ7O2VBR2NQLEkiLCJzb3VyY2VzQ29udGVudCI6WyIvKiBlc2xpbnQtZGlzYWJsZSBwcm9taXNlL3ByZWZlci1hd2FpdC10by1jYWxsYmFja3MgKi9cblxuaW1wb3J0IHsgc3Bhd24gfSBmcm9tICdjaGlsZF9wcm9jZXNzJztcbmltcG9ydCB7IHF1b3RlIH0gZnJvbSAnc2hlbGwtcXVvdGUnO1xuaW1wb3J0IEIgZnJvbSAnYmx1ZWJpcmQnO1xuXG5cbmZ1bmN0aW9uIGV4ZWMgKGNtZCwgYXJncyA9IFtdLCBvcHRzID0ge30pIHtcbiAgLy8gZ2V0IGEgcXVvdGVkIHJlcHJlc2VudGF0aW9uIG9mIHRoZSBjb21tYW5kIGZvciBlcnJvciBzdHJpbmdzXG4gIGNvbnN0IHJlcCA9IHF1b3RlKFtjbWQsIC4uLmFyZ3NdKTtcblxuICAvLyBleHRlbmQgZGVmYXVsdCBvcHRpb25zOyB3ZSdyZSBiYXNpY2FsbHkgcmUtaW1wbGVtZW50aW5nIGV4ZWMncyBvcHRpb25zXG4gIC8vIGZvciB1c2UgaGVyZSB3aXRoIHNwYXduIHVuZGVyIHRoZSBob29kXG4gIG9wdHMgPSBPYmplY3QuYXNzaWduKHtcbiAgICB0aW1lb3V0OiBudWxsLFxuICAgIGVuY29kaW5nOiAndXRmOCcsXG4gICAga2lsbFNpZ25hbDogJ1NJR1RFUk0nLFxuICAgIGN3ZDogdW5kZWZpbmVkLFxuICAgIGVudjogcHJvY2Vzcy5lbnYsXG4gICAgaWdub3JlT3V0cHV0OiBmYWxzZSxcbiAgICBzdGRpbzogXCJpbmhlcml0XCIsXG4gICAgaXNCdWZmZXI6IGZhbHNlLFxuICAgIHNoZWxsOiB1bmRlZmluZWQsXG4gIH0sIG9wdHMpO1xuXG4gIC8vIHRoaXMgaXMgYW4gYXN5bmMgZnVuY3Rpb24sIHNvIHJldHVybiBhIHByb21pc2VcbiAgcmV0dXJuIG5ldyBCKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAvLyBzcGF3biB0aGUgY2hpbGQgcHJvY2VzcyB3aXRoIG9wdGlvbnM7IHdlIGRvbid0IGN1cnJlbnRseSBleHBvc2UgYW55IG9mXG4gICAgLy8gdGhlIG90aGVyICdzcGF3bicgb3B0aW9ucyB0aHJvdWdoIHRoZSBBUElcbiAgICBsZXQgcHJvYyA9IHNwYXduKGNtZCwgYXJncywge2N3ZDogb3B0cy5jd2QsIGVudjogb3B0cy5lbnYsIHNoZWxsOiBvcHRzLnNoZWxsfSk7XG4gICAgbGV0IHN0ZG91dEFyciA9IFtdLCBzdGRlcnJBcnIgPSBbXSwgdGltZXIgPSBudWxsO1xuXG4gICAgLy8gaWYgdGhlIHByb2Nlc3MgZXJyb3JzIG91dCwgcmVqZWN0IHRoZSBwcm9taXNlXG4gICAgcHJvYy5vbignZXJyb3InLCAoZXJyKSA9PiB7XG4gICAgICBsZXQgbXNnID0gYENvbW1hbmQgJyR7cmVwfScgZXJyb3JlZCBvdXQ6ICR7ZXJyLnN0YWNrfWA7XG4gICAgICBpZiAoZXJyLmVycm5vID09PSAnRU5PRU5UJykge1xuICAgICAgICBtc2cgPSBgQ29tbWFuZCAnJHtjbWR9JyBub3QgZm91bmQuIElzIGl0IGluc3RhbGxlZD9gO1xuICAgICAgfVxuICAgICAgcmVqZWN0KG5ldyBFcnJvcihtc2cpKTtcbiAgICB9KTtcbiAgICBpZiAocHJvYy5zdGRpbikge1xuICAgICAgcHJvYy5zdGRpbi5vbignZXJyb3InLCAoZXJyKSA9PiB7XG4gICAgICAgIHJlamVjdChuZXcgRXJyb3IoYFN0YW5kYXJkIGlucHV0ICcke2Vyci5zeXNjYWxsfScgZXJyb3I6ICR7ZXJyLnN0YWNrfWApKTtcbiAgICAgIH0pO1xuICAgIH1cbiAgICBpZiAocHJvYy5zdGRvdXQpIHtcbiAgICAgIHByb2Muc3Rkb3V0Lm9uKCdlcnJvcicsIChlcnIpID0+IHtcbiAgICAgICAgcmVqZWN0KG5ldyBFcnJvcihgU3RhbmRhcmQgb3V0cHV0ICcke2Vyci5zeXNjYWxsfScgZXJyb3I6ICR7ZXJyLnN0YWNrfWApKTtcbiAgICAgIH0pO1xuICAgIH1cbiAgICBpZiAocHJvYy5zdGRlcnIpIHtcbiAgICAgIHByb2Muc3RkZXJyLm9uKCdlcnJvcicsIChlcnIpID0+IHtcbiAgICAgICAgcmVqZWN0KG5ldyBFcnJvcihgU3RhbmRhcmQgZXJyb3IgJyR7ZXJyLnN5c2NhbGx9JyBlcnJvcjogJHtlcnIuc3RhY2t9YCkpO1xuICAgICAgfSk7XG4gICAgfVxuXG4gICAgLy8ga2VlcCB0cmFjayBvZiBzdGRvdXQvc3RkZXJyIGlmIHdlIGhhdmVuJ3Qgc2FpZCBub3QgdG9cbiAgICBpZiAoIW9wdHMuaWdub3JlT3V0cHV0KSB7XG4gICAgICBpZiAocHJvYy5zdGRvdXQpIHtcbiAgICAgICAgcHJvYy5zdGRvdXQub24oJ2RhdGEnLCAoZGF0YSkgPT4ge1xuICAgICAgICAgIHN0ZG91dEFyci5wdXNoKGRhdGEpO1xuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICAgIGlmIChwcm9jLnN0ZGVycikge1xuICAgICAgICBwcm9jLnN0ZGVyci5vbignZGF0YScsIChkYXRhKSA9PiB7XG4gICAgICAgICAgc3RkZXJyQXJyLnB1c2goZGF0YSk7XG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH1cblxuICAgIGZ1bmN0aW9uIGdldFN0ZGlvIChpc0J1ZmZlcikge1xuICAgICAgbGV0IHN0ZG91dCwgc3RkZXJyO1xuICAgICAgaWYgKGlzQnVmZmVyKSB7XG4gICAgICAgIHN0ZG91dCA9IEJ1ZmZlci5jb25jYXQoc3Rkb3V0QXJyKTtcbiAgICAgICAgc3RkZXJyID0gQnVmZmVyLmNvbmNhdChzdGRlcnJBcnIpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgc3Rkb3V0ID0gQnVmZmVyLmNvbmNhdChzdGRvdXRBcnIpLnRvU3RyaW5nKG9wdHMuZW5jb2RpbmcpO1xuICAgICAgICBzdGRlcnIgPSBCdWZmZXIuY29uY2F0KHN0ZGVyckFycikudG9TdHJpbmcob3B0cy5lbmNvZGluZyk7XG4gICAgICB9XG4gICAgICByZXR1cm4ge3N0ZG91dCwgc3RkZXJyfTtcbiAgICB9XG5cbiAgICAvLyBpZiB0aGUgcHJvY2VzcyBlbmRzLCBlaXRoZXIgcmVzb2x2ZSBvciByZWplY3QgdGhlIHByb21pc2UgYmFzZWQgb24gdGhlXG4gICAgLy8gZXhpdCBjb2RlIG9mIHRoZSBwcm9jZXNzLiBlaXRoZXIgd2F5LCBhdHRhY2ggc3Rkb3V0LCBzdGRlcnIsIGFuZCBjb2RlLlxuICAgIC8vIEFsc28gY2xlYW4gdXAgdGhlIHRpbWVyIGlmIGl0IGV4aXN0c1xuICAgIHByb2Mub24oJ2Nsb3NlJywgKGNvZGUpID0+IHtcbiAgICAgIGlmICh0aW1lcikge1xuICAgICAgICBjbGVhclRpbWVvdXQodGltZXIpO1xuICAgICAgfVxuICAgICAgbGV0IHtzdGRvdXQsIHN0ZGVycn0gPSBnZXRTdGRpbyhvcHRzLmlzQnVmZmVyKTtcbiAgICAgIGlmIChjb2RlID09PSAwKSB7XG4gICAgICAgIHJlc29sdmUoe3N0ZG91dCwgc3RkZXJyLCBjb2RlfSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBsZXQgZXJyID0gbmV3IEVycm9yKGBDb21tYW5kICcke3JlcH0nIGV4aXRlZCB3aXRoIGNvZGUgJHtjb2RlfWApO1xuICAgICAgICBlcnIgPSBPYmplY3QuYXNzaWduKGVyciwge3N0ZG91dCwgc3RkZXJyLCBjb2RlfSk7XG4gICAgICAgIHJlamVjdChlcnIpO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgLy8gaWYgd2Ugc2V0IGEgdGltZW91dCBvbiB0aGUgY2hpbGQgcHJvY2VzcywgY3V0IGludG8gdGhlIGV4ZWN1dGlvbiBhbmRcbiAgICAvLyByZWplY3QgaWYgdGhlIHRpbWVvdXQgaXMgcmVhY2hlZC4gQXR0YWNoIHRoZSBzdGRvdXQvc3RkZXJyIHdlIGN1cnJlbnRseVxuICAgIC8vIGhhdmUgaW4gY2FzZSBpdCdzIGhlbHBmdWwgaW4gZGVidWdnaW5nXG4gICAgaWYgKG9wdHMudGltZW91dCkge1xuICAgICAgdGltZXIgPSBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgbGV0IHtzdGRvdXQsIHN0ZGVycn0gPSBnZXRTdGRpbyhvcHRzLmlzQnVmZmVyKTtcbiAgICAgICAgbGV0IGVyciA9IG5ldyBFcnJvcihgQ29tbWFuZCAnJHtyZXB9JyB0aW1lZCBvdXQgYWZ0ZXIgJHtvcHRzLnRpbWVvdXR9bXNgKTtcbiAgICAgICAgZXJyID0gT2JqZWN0LmFzc2lnbihlcnIsIHtzdGRvdXQsIHN0ZGVyciwgY29kZTogbnVsbH0pO1xuICAgICAgICByZWplY3QoZXJyKTtcbiAgICAgICAgLy8gcmVqZWN0IGFuZCBUSEVOIGtpbGwgdG8gYXZvaWQgcmFjZSBjb25kaXRpb25zIHdpdGggdGhlIGhhbmRsZXJzXG4gICAgICAgIC8vIGFib3ZlXG4gICAgICAgIHByb2Mua2lsbChvcHRzLmtpbGxTaWduYWwpO1xuICAgICAgfSwgb3B0cy50aW1lb3V0KTtcbiAgICB9XG4gIH0pO1xufVxuXG5leHBvcnQgeyBleGVjIH07XG5leHBvcnQgZGVmYXVsdCBleGVjO1xuIl0sImZpbGUiOiJsaWIvZXhlYy5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLiJ9
