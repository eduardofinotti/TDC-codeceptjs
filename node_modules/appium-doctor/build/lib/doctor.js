"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.FixSkippedError = exports.DoctorCheck = exports.Doctor = void 0;

require("source-map-support/register");

require("colors");

var _lodash = _interopRequireDefault(require("lodash"));

var _logger = _interopRequireDefault(require("./logger"));

var _package = require("../../package.json");

class FixSkippedError extends Error {}

exports.FixSkippedError = FixSkippedError;

class DoctorCheck {
  constructor(opts = {}) {
    this.autofix = !!opts.autofix;
  }

  diagnose() {
    throw new Error('Not Implemented!');
  }

  fix() {
    throw new Error('Not Implemented!');
  }

}

exports.DoctorCheck = DoctorCheck;

class Doctor {
  constructor() {
    this.checks = [];
    this.checkOptionals = [];
    this.toFix = [];
    this.toFixOptionals = [];
  }

  register(checks) {
    checks = Array.isArray(checks) ? checks : [checks];
    this.checks = this.checks.concat(checks);
  }

  async diagnose() {
    _logger.default.info(`### Diagnostic for ${'necessary'.green} dependencies starting ###`);

    this.toFix = [];

    for (const check of this.checks) {
      const res = await check.diagnose();

      if (res.optional) {
        this.checkOptionals.push(check);
        continue;
      }

      await this.diagnosticResultMessage(res, this.toFix, check);
    }

    _logger.default.info(`### Diagnostic for necessary dependencies completed, ${await this.fixMessage(this.toFix.length)}. ###`);

    _logger.default.info('');

    _logger.default.info(`### Diagnostic for ${'optional'.yellow} dependencies starting ###`);

    this.toFixOptionals = [];

    for (const checkOptional of this.checkOptionals) {
      await this.diagnosticResultMessage((await checkOptional.diagnose()), this.toFixOptionals, checkOptional);
    }

    _logger.default.info(`### Diagnostic for optional dependencies completed, ${await this.fixMessage(this.toFixOptionals.length, true)}. ###`);

    _logger.default.info('');
  }

  async reportManualFixes(fix, fixOptioal) {
    const manualFixes = _lodash.default.filter(fix, f => {
      return !f.check.autofix;
    });

    const manualFixesOptional = _lodash.default.filter(fixOptioal, f => {
      return !f.check.autofix;
    });

    if (manualFixes.length > 0) {
      _logger.default.info('### Manual Fixes Needed ###');

      _logger.default.info('The configuration cannot be automatically fixed, please do the following first:');

      const fixMessages = [];

      for (const f of manualFixes) {
        fixMessages.push((await f.check.fix()));
      }

      for (const m of _lodash.default.uniq(fixMessages)) {
        _logger.default.warn(` \u279C ${m}`);
      }

      _logger.default.info('');
    }

    if (manualFixesOptional.length > 0) {
      _logger.default.info('### Optional Manual Fixes ###');

      _logger.default.info('The configuration can install optionally. Please do the following manually:');

      const fixMessages = [];

      for (const f of manualFixesOptional) {
        fixMessages.push((await f.check.fix()));
      }

      for (const m of _lodash.default.uniq(fixMessages)) {
        _logger.default.warn(` \u279C ${m}`);
      }

      _logger.default.info('');
    }

    if (manualFixes.length > 0 || manualFixesOptional.length > 0) {
      _logger.default.info('###');

      _logger.default.info('');

      _logger.default.info('Bye! Run appium-doctor again when all manual fixes have been applied!');

      _logger.default.info('');

      return true;
    }

    return false;
  }

  async runAutoFix(f) {
    _logger.default.info(`### Fixing: ${f.error} ###`);

    try {
      await f.check.fix();
    } catch (err) {
      if (err instanceof FixSkippedError) {
        _logger.default.info(`### Skipped fix ###`);

        return;
      } else {
        _logger.default.warn(`${err}`.replace(/\n$/g, ''));

        _logger.default.info(`### Fix did not succeed ###`);

        return;
      }
    }

    _logger.default.info('Checking if this was fixed:');

    let res = await f.check.diagnose();

    if (res.ok) {
      f.fixed = true;

      _logger.default.info(` ${'\u2714'.green} ${res.message}`);

      _logger.default.info(`### Fix was successfully applied ###`);
    } else {
      _logger.default.info(` ${'\u2716'.red} ${res.message}`);

      _logger.default.info(`### Fix was applied but issue remains ###`);
    }
  }

  async runAutoFixes() {
    let autoFixes = _lodash.default.filter(this.toFix, f => {
      return f.check.autofix;
    });

    for (let f of autoFixes) {
      await this.runAutoFix(f);

      _logger.default.info('');
    }

    if (_lodash.default.find(autoFixes, f => {
      return !f.fixed;
    })) {
      _logger.default.info('Bye! A few issues remain, fix manually and/or rerun appium-doctor!');
    } else {
      _logger.default.info('Bye! All issues have been fixed!');
    }

    _logger.default.info('');
  }

  async run() {
    _logger.default.info(`Appium Doctor v.${_package.version}`);

    await this.diagnose();

    if (await this.reportSuccess(this.toFix.length, this.toFixOptionals.length)) {
      return;
    }

    if (await this.reportManualFixes(this.toFix, this.toFixOptionals)) {
      return;
    }

    await this.runAutoFixes();
  }

  async diagnosticResultMessage(result, toFixList, check) {
    if (result.ok) {
      _logger.default.info(` ${'\u2714'.green} ${result.message}`);
    } else {
      const errorMessage = result.optional ? ` ${'\u2716'.yellow} ${result.message}` : ` ${'\u2716'.red} ${result.message}`;

      _logger.default.warn(errorMessage);

      toFixList.push({
        error: errorMessage,
        check
      });
    }
  }

  async fixMessage(length, optional = false) {
    let message;

    switch (length) {
      case 0:
        message = 'no fix';
        break;

      case 1:
        message = 'one fix';
        break;

      default:
        message = `${length} fixes`;
    }

    return `${message} ${optional ? 'possible' : 'needed'}`;
  }

  async reportSuccess(length, lengthOptional) {
    if (length === 0 && lengthOptional === 0) {
      _logger.default.info('Everything looks good, bye!');

      _logger.default.info('');

      return true;
    } else {
      return false;
    }
  }

}

exports.Doctor = Doctor;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9kb2N0b3IuanMiXSwibmFtZXMiOlsiRml4U2tpcHBlZEVycm9yIiwiRXJyb3IiLCJEb2N0b3JDaGVjayIsImNvbnN0cnVjdG9yIiwib3B0cyIsImF1dG9maXgiLCJkaWFnbm9zZSIsImZpeCIsIkRvY3RvciIsImNoZWNrcyIsImNoZWNrT3B0aW9uYWxzIiwidG9GaXgiLCJ0b0ZpeE9wdGlvbmFscyIsInJlZ2lzdGVyIiwiQXJyYXkiLCJpc0FycmF5IiwiY29uY2F0IiwibG9nIiwiaW5mbyIsImdyZWVuIiwiY2hlY2siLCJyZXMiLCJvcHRpb25hbCIsInB1c2giLCJkaWFnbm9zdGljUmVzdWx0TWVzc2FnZSIsImZpeE1lc3NhZ2UiLCJsZW5ndGgiLCJ5ZWxsb3ciLCJjaGVja09wdGlvbmFsIiwicmVwb3J0TWFudWFsRml4ZXMiLCJmaXhPcHRpb2FsIiwibWFudWFsRml4ZXMiLCJfIiwiZmlsdGVyIiwiZiIsIm1hbnVhbEZpeGVzT3B0aW9uYWwiLCJmaXhNZXNzYWdlcyIsIm0iLCJ1bmlxIiwid2FybiIsInJ1bkF1dG9GaXgiLCJlcnJvciIsImVyciIsInJlcGxhY2UiLCJvayIsImZpeGVkIiwibWVzc2FnZSIsInJlZCIsInJ1bkF1dG9GaXhlcyIsImF1dG9GaXhlcyIsImZpbmQiLCJydW4iLCJ2ZXJzaW9uIiwicmVwb3J0U3VjY2VzcyIsInJlc3VsdCIsInRvRml4TGlzdCIsImVycm9yTWVzc2FnZSIsImxlbmd0aE9wdGlvbmFsIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUdBLE1BQU1BLGVBQU4sU0FBOEJDLEtBQTlCLENBQW9DOzs7O0FBR3BDLE1BQU1DLFdBQU4sQ0FBa0I7QUFDaEJDLEVBQUFBLFdBQVcsQ0FBRUMsSUFBSSxHQUFHLEVBQVQsRUFBYTtBQUN0QixTQUFLQyxPQUFMLEdBQWUsQ0FBQyxDQUFDRCxJQUFJLENBQUNDLE9BQXRCO0FBQ0Q7O0FBRURDLEVBQUFBLFFBQVEsR0FBSTtBQUFF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MkIsTUFBTSxDQUFDUixPQUFRLEVBQXhELEdBQTZELElBQUcsU0FBU0MsR0FBSSxJQUFHTyxNQUFNLENBQUNSLE9BQVEsRUFBcEg7O0FBQ0E3QixzQkFBSXNCLElBQUosQ0FBU2lCLFlBQVQ7O0FBQ0FELE1BQUFBLFNBQVMsQ0FBQ2hDLElBQVYsQ0FBZTtBQUNia0IsUUFBQUEsS0FBSyxFQUFFZSxZQURNO0FBRWJwQyxRQUFBQTtBQUZhLE9BQWY7QUFJRDtBQUNGOztBQUVELFFBQU1LLFVBQU4sQ0FBa0JDLE1BQWxCLEVBQTBCSixRQUFRLEdBQUcsS0FBckMsRUFBNEM7QUFDMUMsUUFBSXdCLE9BQUo7O0FBQ0EsWUFBUXBCLE1BQVI7QUFDRSxXQUFLLENBQUw7QUFDRW9CLFFBQUFBLE9BQU8sR0FBRyxRQUFWO0FBQ0E7O0FBQ0YsV0FBSyxDQUFMO0FBQ0VBLFFBQUFBLE9BQU8sR0FBRyxTQUFWO0FBQ0E7O0FBQ0Y7QUFDRUEsUUFBQUEsT0FBTyxHQUFJLEdBQUVwQixNQUFPLFFBQXBCO0FBUko7O0FBVUEsV0FBUSxHQUFFb0IsT0FBUSxJQUFHeEIsUUFBUSxHQUFHLFVBQUgsR0FBZ0IsUUFBUyxFQUF0RDtBQUNEOztBQUVELFFBQU0rQixhQUFOLENBQXFCM0IsTUFBckIsRUFBNkIrQixjQUE3QixFQUE2QztBQUMzQyxRQUFJL0IsTUFBTSxLQUFLLENBQVgsSUFBZ0IrQixjQUFjLEtBQUssQ0FBdkMsRUFBMEM7QUFDeEN4QyxzQkFBSUMsSUFBSixDQUFTLDZCQUFUOztBQUNBRCxzQkFBSUMsSUFBSixDQUFTLEVBQVQ7O0FBQ0EsYUFBTyxJQUFQO0FBQ0QsS0FKRCxNQUlPO0FBQ0wsYUFBTyxLQUFQO0FBQ0Q7QUFDRjs7QUF4S1UiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgJ2NvbG9ycyc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IGxvZyBmcm9tICcuL2xvZ2dlcic7XG5pbXBvcnQgeyB2ZXJzaW9uIH0gZnJvbSAnLi4vLi4vcGFja2FnZS5qc29uJzsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBpbXBvcnQvbm8tdW5yZXNvbHZlZFxuXG5cbmNsYXNzIEZpeFNraXBwZWRFcnJvciBleHRlbmRzIEVycm9yIHtcbn1cblxuY2xhc3MgRG9jdG9yQ2hlY2sge1xuICBjb25zdHJ1Y3RvciAob3B0cyA9IHt9KSB7XG4gICAgdGhpcy5hdXRvZml4ID0gISFvcHRzLmF1dG9maXg7XG4gIH1cblxuICBkaWFnbm9zZSAoKSB7IHRocm93IG5ldyBFcnJvcignTm90IEltcGxlbWVudGVkIScpOyB9XG5cbiAgZml4ICgpIHtcbiAgICAvLyByZXR1cm4gc3RyaW5nIGZvciBtYW51YWwgZml4ZXMuXG4gICAgdGhyb3cgbmV3IEVycm9yKCdOb3QgSW1wbGVtZW50ZWQhJyk7XG4gIH1cbn1cblxuY2xhc3MgRG9jdG9yIHtcbiAgY29uc3RydWN0b3IgKCkge1xuICAgIHRoaXMuY2hlY2tzID0gW107XG4gICAgdGhpcy5jaGVja09wdGlvbmFscyA9IFtdO1xuICAgIHRoaXMudG9GaXggPSBbXTtcbiAgICB0aGlzLnRvRml4T3B0aW9uYWxzID0gW107XG4gIH1cblxuICByZWdpc3RlciAoY2hlY2tzKSB7XG4gICAgY2hlY2tzID0gQXJyYXkuaXNBcnJheShjaGVja3MpID8gY2hlY2tzIDogW2NoZWNrc107XG4gICAgdGhpcy5jaGVja3MgPSB0aGlzLmNoZWNrcy5jb25jYXQoY2hlY2tzKTtcbiAgfVxuXG4gIGFzeW5jIGRpYWdub3NlICgpIHtcbiAgICBsb2cuaW5mbyhgIyMjIERpYWdub3N0aWMgZm9yICR7J25lY2Vzc2FyeScuZ3JlZW59IGRlcGVuZGVuY2llcyBzdGFydGluZyAjIyNgKTtcbiAgICB0aGlzLnRvRml4ID0gW107XG4gICAgZm9yIChjb25zdCBjaGVjayBvZiB0aGlzLmNoZWNrcykge1xuICAgICAgY29uc3QgcmVzID0gYXdhaXQgY2hlY2suZGlhZ25vc2UoKTtcbiAgICAgIGlmIChyZXMub3B0aW9uYWwpIHtcbiAgICAgICAgdGhpcy5jaGVja09wdGlvbmFscy5wdXNoKGNoZWNrKTtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG4gICAgICBhd2FpdCB0aGlzLmRpYWdub3N0aWNSZXN1bHRNZXNzYWdlKHJlcywgdGhpcy50b0ZpeCwgY2hlY2spO1xuICAgIH1cbiAgICBsb2cuaW5mbyhgIyMjIERpYWdub3N0aWMgZm9yIG5lY2Vzc2FyeSBkZXBlbmRlbmNpZXMgY29tcGxldGVkLCAke2F3YWl0IHRoaXMuZml4TWVzc2FnZSh0aGlzLnRvRml4Lmxlbmd0aCl9LiAjIyNgKTtcbiAgICBsb2cuaW5mbygnJyk7XG5cbiAgICBsb2cuaW5mbyhgIyMjIERpYWdub3N0aWMgZm9yICR7J29wdGlvbmFsJy55ZWxsb3d9IGRlcGVuZGVuY2llcyBzdGFydGluZyAjIyNgKTtcbiAgICB0aGlzLnRvRml4T3B0aW9uYWxzID0gW107XG4gICAgZm9yIChjb25zdCBjaGVja09wdGlvbmFsIG9mIHRoaXMuY2hlY2tPcHRpb25hbHMpIHtcbiAgICAgIGF3YWl0IHRoaXMuZGlhZ25vc3RpY1Jlc3VsdE1lc3NhZ2UoYXdhaXQgY2hlY2tPcHRpb25hbC5kaWFnbm9zZSgpLCB0aGlzLnRvRml4T3B0aW9uYWxzLCBjaGVja09wdGlvbmFsKTtcbiAgICB9XG4gICAgbG9nLmluZm8oYCMjIyBEaWFnbm9zdGljIGZvciBvcHRpb25hbCBkZXBlbmRlbmNpZXMgY29tcGxldGVkLCAke2F3YWl0IHRoaXMuZml4TWVzc2FnZSh0aGlzLnRvRml4T3B0aW9uYWxzLmxlbmd0aCwgdHJ1ZSl9LiAjIyNgKTtcbiAgICBsb2cuaW5mbygnJyk7XG4gIH1cblxuICBhc3luYyByZXBvcnRNYW51YWxGaXhlcyAoZml4LCBmaXhPcHRpb2FsKSB7XG4gICAgY29uc3QgbWFudWFsRml4ZXMgPSBfLmZpbHRlcihmaXgsIChmKSA9PiB7cmV0dXJuICFmLmNoZWNrLmF1dG9maXg7fSk7XG4gICAgY29uc3QgbWFudWFsRml4ZXNPcHRpb25hbCA9IF8uZmlsdGVyKGZpeE9wdGlvYWwsIChmKSA9PiB7cmV0dXJuICFmLmNoZWNrLmF1dG9maXg7fSk7XG5cbiAgICBpZiAobWFudWFsRml4ZXMubGVuZ3RoID4gMCkge1xuICAgICAgbG9nLmluZm8oJyMjIyBNYW51YWwgRml4ZXMgTmVlZGVkICMjIycpO1xuICAgICAgbG9nLmluZm8oJ1RoZSBjb25maWd1cmF0aW9uIGNhbm5vdCBiZSBhdXRvbWF0aWNhbGx5IGZpeGVkLCBwbGVhc2UgZG8gdGhlIGZvbGxvd2luZyBmaXJzdDonKTtcbiAgICAgIC8vIGZvciBtYW51YWwgZml4ZXMsIHRoZSBmaXggbWV0aG9kIGFsd2F5cyByZXR1cm4gYSBzdHJpbmdcbiAgICAgIGNvbnN0IGZpeE1lc3NhZ2VzID0gW107XG4gICAgICBmb3IgKGNvbnN0IGYgb2YgbWFudWFsRml4ZXMpIHtcbiAgICAgICAgZml4TWVzc2FnZXMucHVzaChhd2FpdCBmLmNoZWNrLmZpeCgpKTtcbiAgICAgIH1cbiAgICAgIGZvciAoY29uc3QgbSBvZiBfLnVuaXEoZml4TWVzc2FnZXMpKSB7XG4gICAgICAgIGxvZy53YXJuKGAgXFx1Mjc5QyAke219YCk7XG4gICAgICB9XG4gICAgICBsb2cuaW5mbygnJyk7XG4gICAgfVxuICAgIGlmIChtYW51YWxGaXhlc09wdGlvbmFsLmxlbmd0aCA+IDApIHtcbiAgICAgIGxvZy5pbmZvKCcjIyMgT3B0aW9uYWwgTWFudWFsIEZpeGVzICMjIycpO1xuICAgICAgbG9nLmluZm8oJ1RoZSBjb25maWd1cmF0aW9uIGNhbiBpbnN0YWxsIG9wdGlvbmFsbHkuIFBsZWFzZSBkbyB0aGUgZm9sbG93aW5nIG1hbnVhbGx5OicpO1xuICAgICAgLy8gZm9yIG1hbnVhbCBmaXhlcywgdGhlIGZpeCBtZXRob2QgYWx3YXlzIHJldHVybiBhIHN0cmluZ1xuICAgICAgY29uc3QgZml4TWVzc2FnZXMgPSBbXTtcbiAgICAgIGZvciAoY29uc3QgZiBvZiBtYW51YWxGaXhlc09wdGlvbmFsKSB7XG4gICAgICAgIGZpeE1lc3NhZ2VzLnB1c2goYXdhaXQgZi5jaGVjay5maXgoKSk7XG4gICAgICB9XG4gICAgICBmb3IgKGNvbnN0IG0gb2YgXy51bmlxKGZpeE1lc3NhZ2VzKSkge1xuICAgICAgICBsb2cud2FybihgIFxcdTI3OUMgJHttfWApO1xuICAgICAgfVxuICAgICAgbG9nLmluZm8oJycpO1xuICAgIH1cblxuICAgIGlmIChtYW51YWxGaXhlcy5sZW5ndGggPiAwIHx8IG1hbnVhbEZpeGVzT3B0aW9uYWwubGVuZ3RoID4gMCkge1xuICAgICAgbG9nLmluZm8oJyMjIycpO1xuICAgICAgbG9nLmluZm8oJycpO1xuICAgICAgbG9nLmluZm8oJ0J5ZSEgUnVuIGFwcGl1bS1kb2N0b3IgYWdhaW4gd2hlbiBhbGwgbWFudWFsIGZpeGVzIGhhdmUgYmVlbiBhcHBsaWVkIScpO1xuICAgICAgbG9nLmluZm8oJycpO1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIGFzeW5jIHJ1bkF1dG9GaXggKGYpIHtcbiAgICBsb2cuaW5mbyhgIyMjIEZpeGluZzogJHtmLmVycm9yfSAjIyNgKTtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgZi5jaGVjay5maXgoKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGlmIChlcnIgaW5zdGFuY2VvZiBGaXhTa2lwcGVkRXJyb3IpIHtcbiAgICAgICAgbG9nLmluZm8oYCMjIyBTa2lwcGVkIGZpeCAjIyNgKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbG9nLndhcm4oYCR7ZXJyfWAucmVwbGFjZSgvXFxuJC9nLCAnJykpO1xuICAgICAgICBsb2cuaW5mbyhgIyMjIEZpeCBkaWQgbm90IHN1Y2NlZWQgIyMjYCk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICB9XG4gICAgbG9nLmluZm8oJ0NoZWNraW5nIGlmIHRoaXMgd2FzIGZpeGVkOicpO1xuICAgIGxldCByZXMgPSBhd2FpdCBmLmNoZWNrLmRpYWdub3NlKCk7XG4gICAgaWYgKHJlcy5vaykge1xuICAgICAgZi5maXhlZCA9IHRydWU7XG4gICAgICBsb2cuaW5mbyhgICR7J1xcdTI3MTQnLmdyZWVufSAke3Jlcy5tZXNzYWdlfWApO1xuICAgICAgbG9nLmluZm8oYCMjIyBGaXggd2FzIHN1Y2Nlc3NmdWxseSBhcHBsaWVkICMjI2ApO1xuICAgIH0gZWxzZSB7XG4gICAgICBsb2cuaW5mbyhgICR7J1xcdTI3MTYnLnJlZH0gJHtyZXMubWVzc2FnZX1gKTtcbiAgICAgIGxvZy5pbmZvKGAjIyMgRml4IHdhcyBhcHBsaWVkIGJ1dCBpc3N1ZSByZW1haW5zICMjI2ApO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHJ1bkF1dG9GaXhlcyAoKSB7XG4gICAgbGV0IGF1dG9GaXhlcyA9IF8uZmlsdGVyKHRoaXMudG9GaXgsIChmKSA9PiB7cmV0dXJuIGYuY2hlY2suYXV0b2ZpeDt9KTtcbiAgICBmb3IgKGxldCBmIG9mIGF1dG9GaXhlcykge1xuICAgICAgYXdhaXQgdGhpcy5ydW5BdXRvRml4KGYpO1xuICAgICAgbG9nLmluZm8oJycpO1xuICAgIH1cbiAgICBpZiAoXy5maW5kKGF1dG9GaXhlcywgKGYpID0+IHsgcmV0dXJuICFmLmZpeGVkOyB9KSkge1xuICAgICAgLy8gYSBmZXcgaXNzdWVzIHJlbWFpbi5cbiAgICAgIGxvZy5pbmZvKCdCeWUhIEEgZmV3IGlzc3VlcyByZW1haW4sIGZpeCBtYW51YWxseSBhbmQvb3IgcmVydW4gYXBwaXVtLWRvY3RvciEnKTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gbm90aGluZyBsZWZ0IHRvIGZpeC5cbiAgICAgIGxvZy5pbmZvKCdCeWUhIEFsbCBpc3N1ZXMgaGF2ZSBiZWVuIGZpeGVkIScpO1xuICAgIH1cbiAgICBsb2cuaW5mbygnJyk7XG4gIH1cblxuICBhc3luYyBydW4gKCkge1xuICAgIGxvZy5pbmZvKGBBcHBpdW0gRG9jdG9yIHYuJHt2ZXJzaW9ufWApO1xuICAgIGF3YWl0IHRoaXMuZGlhZ25vc2UoKTtcbiAgICBpZiAoYXdhaXQgdGhpcy5yZXBvcnRTdWNjZXNzKHRoaXMudG9GaXgubGVuZ3RoLCB0aGlzLnRvRml4T3B0aW9uYWxzLmxlbmd0aCkpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKGF3YWl0IHRoaXMucmVwb3J0TWFudWFsRml4ZXModGhpcy50b0ZpeCwgdGhpcy50b0ZpeE9wdGlvbmFscykpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgYXdhaXQgdGhpcy5ydW5BdXRvRml4ZXMoKTtcbiAgfVxuXG4gIC8vLy8gZ2VuZXJhdGluZyBtZXNzYWdlc1xuICBhc3luYyBkaWFnbm9zdGljUmVzdWx0TWVzc2FnZSAocmVzdWx0LCB0b0ZpeExpc3QsIGNoZWNrKSB7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgcmVxdWlyZS1hd2FpdFxuICAgIGlmIChyZXN1bHQub2spIHtcbiAgICAgIGxvZy5pbmZvKGAgJHsnXFx1MjcxNCcuZ3JlZW59ICR7cmVzdWx0Lm1lc3NhZ2V9YCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IGVycm9yTWVzc2FnZSA9IHJlc3VsdC5vcHRpb25hbCA/IGAgJHsnXFx1MjcxNicueWVsbG93fSAke3Jlc3VsdC5tZXNzYWdlfWAgOiBgICR7J1xcdTI3MTYnLnJlZH0gJHtyZXN1bHQubWVzc2FnZX1gO1xuICAgICAgbG9nLndhcm4oZXJyb3JNZXNzYWdlKTtcbiAgICAgIHRvRml4TGlzdC5wdXNoKHtcbiAgICAgICAgZXJyb3I6IGVycm9yTWVzc2FnZSxcbiAgICAgICAgY2hlY2tcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGZpeE1lc3NhZ2UgKGxlbmd0aCwgb3B0aW9uYWwgPSBmYWxzZSkgeyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIHJlcXVpcmUtYXdhaXRcbiAgICBsZXQgbWVzc2FnZTtcbiAgICBzd2l0Y2ggKGxlbmd0aCkge1xuICAgICAgY2FzZSAwOlxuICAgICAgICBtZXNzYWdlID0gJ25vIGZpeCc7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAxOlxuICAgICAgICBtZXNzYWdlID0gJ29uZSBmaXgnO1xuICAgICAgICBicmVhaztcbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIG1lc3NhZ2UgPSBgJHtsZW5ndGh9IGZpeGVzYDtcbiAgICB9XG4gICAgcmV0dXJuIGAke21lc3NhZ2V9ICR7b3B0aW9uYWwgPyAncG9zc2libGUnIDogJ25lZWRlZCd9YDtcbiAgfVxuXG4gIGFzeW5jIHJlcG9ydFN1Y2Nlc3MgKGxlbmd0aCwgbGVuZ3RoT3B0aW9uYWwpIHsgLy8gZXNsaW50LWRpc2FibGUtbGluZSByZXF1aXJlLWF3YWl0XG4gICAgaWYgKGxlbmd0aCA9PT0gMCAmJiBsZW5ndGhPcHRpb25hbCA9PT0gMCkge1xuICAgICAgbG9nLmluZm8oJ0V2ZXJ5dGhpbmcgbG9va3MgZ29vZCwgYnllIScpO1xuICAgICAgbG9nLmluZm8oJycpO1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IHsgRG9jdG9yLCBEb2N0b3JDaGVjaywgRml4U2tpcHBlZEVycm9yIH07XG4iXSwiZmlsZSI6ImxpYi9kb2N0b3IuanMiLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==
