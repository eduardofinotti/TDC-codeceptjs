"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _appiumSupport = require("appium-support");

var _teen_process = require("teen_process");

var _logger = _interopRequireDefault(require("./logger"));

var _path = _interopRequireDefault(require("path"));

var _utils = require("./utils");

const NODE_COMMON_PATHS = [process.env.NODE_BIN, '/usr/local/bin/node', '/opt/local/bin/node'];

class NodeDetector {
  static async retrieveInCommonPlaces() {
    for (let p of NODE_COMMON_PATHS) {
      if (p && (await _appiumSupport.fs.exists(p))) {
        _logger.default.debug(`Node binary found at common place: ${p}`);

        return p;
      }
    }

    _logger.default.debug('Node binary wasn\'t found at common places.');

    return null;
  }

  static async retrieveUsingSystemCall() {
    const nodePath = await (0, _utils.resolveExecutablePath)('node');

    if (!nodePath) {
      _logger.default.debug(`Node binary not found in PATH: ${process.env.PATH}`);

      return null;
    }

    _logger.default.debug(`Node binary found at: ${nodePath}`);

    return nodePath;
  }

  static async retrieveUsingAppleScript() {
    if (!_appiumSupport.system.isMac()) {
      _logger.default.debug('Not on Darwin, skipping Apple Script');

      return null;
    }

    const appScript = ['try', '  set appiumIsRunning to false', '  tell application "System Events"', '    set appiumIsRunning to name of every process contains "Appium"', '  end tell', '  if appiumIsRunning then', '    tell application "Appium" to return node path', '  end if', 'end try', 'return "NULL"'].join('\n');
    let stdout;

    try {
      stdout = (await (0, _teen_process.exec)('osascript', ['-e', appScript])).stdout;
    } catch (err) {
      _logger.default.debug(err);

      return null;
    }

    let nodePath = stdout.replace('\n', '');

    if (await _appiumSupport.fs.exists(nodePath)) {
      _logger.default.debug(`Node binary found using AppleScript at: ${nodePath}`);

      return nodePath;
    } else {
      _logger.default.debug('Node binary not found using AppleScript.');

      return null;
    }
  }

  static async retrieveUsingAppiumConfigFile() {
    let jsonobj;

    try {
      const appiumConfigPath = _path.default.resolve(__dirname, '..', '..', '.appiumconfig.json');

      if (await _appiumSupport.fs.exists(appiumConfigPath)) {
        jsonobj = JSON.parse((await _appiumSupport.fs.readFile(appiumConfigPath, 'utf8')));
      }
    } catch (err) {
      _logger.default.debug(err);

      return null;
    }

    if (jsonobj && jsonobj.node_bin && (await _appiumSupport.fs.exists(jsonobj.node_bin))) {
      _logger.default.debug(`Node binary found using .appiumconfig.json at: ${jsonobj.node_bin}`);

      return jsonobj.node_bin;
    } else {
      _logger.default.debug('Node binary not found in the .appiumconfig.json file.');

      return null;
    }
  }

  static async detect() {
    let nodePath = (await NodeDetector.retrieveUsingSystemCall()) || (await NodeDetector.retrieveInCommonPlaces()) || (await NodeDetector.retrieveUsingAppleScript()) || (await NodeDetector.retrieveUsingAppiumConfigFile());

    if (nodePath) {
      return nodePath;
    } else {
      _logger.default.warn('The node binary could not be found.');

      return null;
    }
  }

}

var _default = NodeDetector;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9ub2RlLWRldGVjdG9yLmpzIl0sIm5hbWVzIjpbIk5PREVfQ09NTU9OX1BBVEhTIiwicHJvY2VzcyIsImVudiIsIk5PREVfQklOIiwiTm9kZURldGVjdG9yIiwicmV0cmlldmVJbkNvbW1vblBsYWNlcyIsInAiLCJmcyIsImV4aXN0cyIsImxvZyIsImRlYnVnIiwicmV0cmlldmVVc2luZ1N5c3RlbUNhbGwiLCJub2RlUGF0aCIsIlBBVEgiLCJyZXRyaWV2ZVVzaW5nQXBwbGVTY3JpcHQiLCJzeXN0ZW0iLCJpc01hYyIsImFwcFNjcmlwdCIsImpvaW4iLCJzdGRvdXQiLCJlcnIiLCJyZXBsYWNlIiwicmV0cmlldmVVc2luZ0FwcGl1bUNvbmZpZ0ZpbGUiLCJqc29ub2JqIiwiYXBwaXVtQ29uZmlnUGF0aCIsInBhdGgiLCJyZXNvbHZlIiwiX19kaXJuYW1lIiwiSlNPTiIsInBhcnNlIiwicmVhZEZpbGUiLCJub2RlX2JpbiIsImRldGVjdCIsIndhcm4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUEsTUFBTUEsaUJBQWlCLEdBQUcsQ0FDeEJDLE9BQU8sQ0FBQ0MsR0FBUixDQUFZQyxRQURZLEVBRXhCLHFCQUZ3QixFQUd4QixxQkFId0IsQ0FBMUI7O0FBT0EsTUFBTUMsWUFBTixDQUFtQjtBQUNqQixlQUFhQyxzQkFBYixHQUF1QztBQUNyQyxTQUFLLElBQUlDLENBQVQsSUFBY04saUJBQWQsRUFBaUM7QUFDL0IsVUFBSU0sQ0FBQyxLQUFJLE1BQU1DLGtCQUFHQyxNQUFILENBQVVGLENBQVYsQ0FBVixDQUFMLEVBQTZCO0FBQzNCRyx3QkFBSUMsS0FBSixDQUFXLHNDQUFxQ0osQ0FBRSxFQUFsRDs7QUFDQSxlQUFPQSxDQUFQO0FBQ0Q7QUFDRjs7QUFDREcsb0JBQUlDLEtBQUosQ0FBVSw2Q0FBVjs7QUFDQSxXQUFPLElBQVA7QUFDRDs7QUFFRCxlQUFhQyx1QkFBYixHQUF3QztBQUN0QyxV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LEtBRkQsTUFFTztBQUNMSCxzQkFBSXdCLElBQUosQ0FBUyxxQ0FBVDs7QUFDQSxhQUFPLElBQVA7QUFDRDtBQUNGOztBQTFGZ0I7O2VBNkZKN0IsWSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGZzLCBzeXN0ZW0gfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgeyBleGVjIH0gZnJvbSAndGVlbl9wcm9jZXNzJztcbmltcG9ydCBsb2cgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgeyByZXNvbHZlRXhlY3V0YWJsZVBhdGggfSBmcm9tICcuL3V0aWxzJztcblxuY29uc3QgTk9ERV9DT01NT05fUEFUSFMgPSBbXG4gIHByb2Nlc3MuZW52Lk5PREVfQklOLFxuICAnL3Vzci9sb2NhbC9iaW4vbm9kZScsXG4gICcvb3B0L2xvY2FsL2Jpbi9ub2RlJyxcbl07XG5cbi8vIExvb2sgZm9yIG5vZGVcbmNsYXNzIE5vZGVEZXRlY3RvciB7XG4gIHN0YXRpYyBhc3luYyByZXRyaWV2ZUluQ29tbW9uUGxhY2VzICgpIHtcbiAgICBmb3IgKGxldCBwIG9mIE5PREVfQ09NTU9OX1BBVEhTKSB7XG4gICAgICBpZiAocCAmJiBhd2FpdCBmcy5leGlzdHMocCkpIHtcbiAgICAgICAgbG9nLmRlYnVnKGBOb2RlIGJpbmFyeSBmb3VuZCBhdCBjb21tb24gcGxhY2U6ICR7cH1gKTtcbiAgICAgICAgcmV0dXJuIHA7XG4gICAgICB9XG4gICAgfVxuICAgIGxvZy5kZWJ1ZygnTm9kZSBiaW5hcnkgd2FzblxcJ3QgZm91bmQgYXQgY29tbW9uIHBsYWNlcy4nKTtcbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG4gIHN0YXRpYyBhc3luYyByZXRyaWV2ZVVzaW5nU3lzdGVtQ2FsbCAoKSB7XG4gICAgY29uc3Qgbm9kZVBhdGggPSBhd2FpdCByZXNvbHZlRXhlY3V0YWJsZVBhdGgoJ25vZGUnKTtcblxuICAgIGlmICghbm9kZVBhdGgpIHtcbiAgICAgIGxvZy5kZWJ1ZyhgTm9kZSBiaW5hcnkgbm90IGZvdW5kIGluIFBBVEg6ICR7cHJvY2Vzcy5lbnYuUEFUSH1gKTtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIGxvZy5kZWJ1ZyhgTm9kZSBiaW5hcnkgZm91bmQgYXQ6ICR7bm9kZVBhdGh9YCk7XG4gICAgcmV0dXJuIG5vZGVQYXRoO1xuICB9XG5cbiAgc3RhdGljIGFzeW5jIHJldHJpZXZlVXNpbmdBcHBsZVNjcmlwdCAoKSB7XG4gICAgaWYgKCFzeXN0ZW0uaXNNYWMoKSkge1xuICAgICAgbG9nLmRlYnVnKCdOb3Qgb24gRGFyd2luLCBza2lwcGluZyBBcHBsZSBTY3JpcHQnKTtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIGNvbnN0IGFwcFNjcmlwdCA9IFtcbiAgICAgICd0cnknXG4gICAgICAsICcgIHNldCBhcHBpdW1Jc1J1bm5pbmcgdG8gZmFsc2UnXG4gICAgICAsICcgIHRlbGwgYXBwbGljYXRpb24gXCJTeXN0ZW0gRXZlbnRzXCInXG4gICAgICAsICcgICAgc2V0IGFwcGl1bUlzUnVubmluZyB0byBuYW1lIG9mIGV2ZXJ5IHByb2Nlc3MgY29udGFpbnMgXCJBcHBpdW1cIidcbiAgICAgICwgJyAgZW5kIHRlbGwnXG4gICAgICAsICcgIGlmIGFwcGl1bUlzUnVubmluZyB0aGVuJ1xuICAgICAgLCAnICAgIHRlbGwgYXBwbGljYXRpb24gXCJBcHBpdW1cIiB0byByZXR1cm4gbm9kZSBwYXRoJ1xuICAgICAgLCAnICBlbmQgaWYnXG4gICAgICAsICdlbmQgdHJ5J1xuICAgICAgLCAncmV0dXJuIFwiTlVMTFwiJ1xuICAgIF0uam9pbignXFxuJyk7XG4gICAgbGV0IHN0ZG91dDtcbiAgICB0cnkge1xuICAgICAgc3Rkb3V0ID0gKGF3YWl0IGV4ZWMoJ29zYXNjcmlwdCcsIFsnLWUnLCBhcHBTY3JpcHRdKSkuc3Rkb3V0O1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgbG9nLmRlYnVnKGVycik7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gICAgbGV0IG5vZGVQYXRoID0gc3Rkb3V0LnJlcGxhY2UoJ1xcbicsICcnKTtcbiAgICBpZiAoYXdhaXQgZnMuZXhpc3RzKG5vZGVQYXRoKSkge1xuICAgICAgbG9nLmRlYnVnKGBOb2RlIGJpbmFyeSBmb3VuZCB1c2luZyBBcHBsZVNjcmlwdCBhdDogJHtub2RlUGF0aH1gKTtcbiAgICAgIHJldHVybiBub2RlUGF0aDtcbiAgICB9IGVsc2Uge1xuICAgICAgbG9nLmRlYnVnKCdOb2RlIGJpbmFyeSBub3QgZm91bmQgdXNpbmcgQXBwbGVTY3JpcHQuJyk7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gIH1cblxuICBzdGF0aWMgYXN5bmMgcmV0cmlldmVVc2luZ0FwcGl1bUNvbmZpZ0ZpbGUgKCkge1xuICAgIGxldCBqc29ub2JqO1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBhcHBpdW1Db25maWdQYXRoID0gcGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgJy4uJywgJy4uJywgJy5hcHBpdW1jb25maWcuanNvbicpO1xuICAgICAgaWYgKGF3YWl0IGZzLmV4aXN0cyhhcHBpdW1Db25maWdQYXRoKSkge1xuICAgICAgICBqc29ub2JqID0gSlNPTi5wYXJzZShhd2FpdCBmcy5yZWFkRmlsZShhcHBpdW1Db25maWdQYXRoLCAndXRmOCcpKTtcbiAgICAgIH1cbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGxvZy5kZWJ1ZyhlcnIpO1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICAgIGlmIChqc29ub2JqICYmIGpzb25vYmoubm9kZV9iaW4gJiYgYXdhaXQgZnMuZXhpc3RzKGpzb25vYmoubm9kZV9iaW4pKSB7XG4gICAgICBsb2cuZGVidWcoYE5vZGUgYmluYXJ5IGZvdW5kIHVzaW5nIC5hcHBpdW1jb25maWcuanNvbiBhdDogJHtqc29ub2JqLm5vZGVfYmlufWApO1xuICAgICAgcmV0dXJuIGpzb25vYmoubm9kZV9iaW47XG4gICAgfSBlbHNlIHtcbiAgICAgIGxvZy5kZWJ1ZygnTm9kZSBiaW5hcnkgbm90IGZvdW5kIGluIHRoZSAuYXBwaXVtY29uZmlnLmpzb24gZmlsZS4nKTtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgfVxuXG4gIHN0YXRpYyBhc3luYyBkZXRlY3QgKCkge1xuICAgIGxldCBub2RlUGF0aCA9IGF3YWl0IE5vZGVEZXRlY3Rvci5yZXRyaWV2ZVVzaW5nU3lzdGVtQ2FsbCgpIHx8XG4gICAgICBhd2FpdCBOb2RlRGV0ZWN0b3IucmV0cmlldmVJbkNvbW1vblBsYWNlcygpIHx8XG4gICAgICBhd2FpdCBOb2RlRGV0ZWN0b3IucmV0cmlldmVVc2luZ0FwcGxlU2NyaXB0KCkgfHxcbiAgICAgIGF3YWl0IE5vZGVEZXRlY3Rvci5yZXRyaWV2ZVVzaW5nQXBwaXVtQ29uZmlnRmlsZSgpO1xuICAgIGlmIChub2RlUGF0aCkge1xuICAgICAgcmV0dXJuIG5vZGVQYXRoO1xuICAgIH0gZWxzZSB7XG4gICAgICBsb2cud2FybignVGhlIG5vZGUgYmluYXJ5IGNvdWxkIG5vdCBiZSBmb3VuZC4nKTtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBOb2RlRGV0ZWN0b3I7XG4iXSwiZmlsZSI6ImxpYi9ub2RlLWRldGVjdG9yLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uIn0=
